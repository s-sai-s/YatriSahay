<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YatriSahay - Home</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <meta name="theme-color" content="#4285f4">
    
    <!-- Android PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="YatriSahay">
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YatriSahay">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#4285f4">
    <meta name="msapplication-TileImage" content="/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4285f4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-email {
            flex: 1;
            color: #333;
            font-size: 14px;
            word-break: break-all;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        .title-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .address-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .address-details {
            font-size: 14px;
            color: #666;
            word-break: break-word;
        }

        .no-address {
            color: #999;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .action-btn {
            background: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #333;
            text-decoration: none;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn.enabled {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-btn.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .action-btn.disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .icon {
            width: 24px;
            height: 24px;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .paste-btn {
            transition: background 0.3s;
        }

        .paste-btn:hover {
            background: #357ae8 !important;
        }

        .paste-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-email" id="userEmail">Loading...</div>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>

        <div class="title-bar">
            <div class="address-name" id="addressName">No address selected</div>
            <div class="address-details no-address" id="addressDetails">Open a Google Maps link to get started</div>
            <!-- iOS Paste Link Button (shown only on iOS when no address) -->
            <button id="pasteLinkBtn" class="paste-btn" style="display: none; margin-top: 10px; padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">
                ðŸ“‹ Paste Google Maps Link
            </button>
        </div>

        <div class="action-buttons">
            <button class="action-btn enabled" id="openMapsBtn">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
                Open Google Maps
            </button>
            <button class="action-btn disabled" id="bookUberBtn" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Book Uber
            </button>
            <button class="action-btn disabled" id="bookRapidoBtn" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Book Rapido
            </button>
        </div>
    </div>

    <script>
        // Store address data
        let addressData = null;
        let hasAddressFromLink = false;

        // Check if app was opened from a Google Maps link
        function checkForMapsLink() {
            const urlParams = new URLSearchParams(window.location.search);
            // Check multiple possible parameter names
            const mapsUrl = urlParams.get('maps_url') || 
                          urlParams.get('url') || 
                          urlParams.get('q') ||
                          urlParams.get('text') ||
                          urlParams.get('link');
            
            if (mapsUrl) {
                hasAddressFromLink = true;
                // Decode the URL
                const decodedUrl = decodeURIComponent(mapsUrl);
                // Extract address from Google Maps URL
                extractAddressFromMapsUrl(decodedUrl);
            } else {
                // Check if the current URL itself is a Google Maps URL
                const currentUrl = window.location.href;
                // Support all Google Maps URL formats
                if (currentUrl.includes('maps.google.com') || 
                    currentUrl.includes('google.com/maps') ||
                    currentUrl.includes('maps.app.goo.gl') ||
                    currentUrl.includes('goo.gl/maps') ||
                    currentUrl.includes('maps/place') ||
                    currentUrl.includes('maps/search') ||
                    currentUrl.includes('maps/dir')) {
                    hasAddressFromLink = true;
                    extractAddressFromMapsUrl(currentUrl);
                } else {
                    // Check if there's address data in sessionStorage (from previous session)
                    const savedAddress = sessionStorage.getItem('addressData');
                    if (savedAddress) {
                        try {
                            addressData = JSON.parse(savedAddress);
                            hasAddressFromLink = true;
                            updateUI();
                            enableBookingButtons();
                        } catch (e) {
                            console.error('Error parsing saved address:', e);
                        }
                    }
                }
            }
        }

        // Extract address from Google Maps URL
        function extractAddressFromMapsUrl(mapsUrl) {
            // Try to extract address from various Google Maps URL formats
            let address = '';
            
            // Format 1: https://maps.google.com/?q=address or ?q=lat,lng
            const qMatch = mapsUrl.match(/[?&]q=([^&]+)/);
            if (qMatch) {
                const qValue = decodeURIComponent(qMatch[1]);
                // Check if it's coordinates (lat,lng format)
                const coordMatch = qValue.match(/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/);
                if (coordMatch) {
                    // It's coordinates, use them directly
                    addressData = {
                        address: `Location at ${qValue}`,
                        addressName: 'Selected Location',
                        lat: parseFloat(coordMatch[1]),
                        lng: parseFloat(coordMatch[2])
                    };
                    sessionStorage.setItem('addressData', JSON.stringify(addressData));
                    updateUI();
                    enableBookingButtons();
                    return;
                } else {
                    address = qValue;
                }
            }
            
            // Format 2: https://www.google.com/maps/place/address
            if (!address) {
                const placeMatch = mapsUrl.match(/\/place\/([^/?]+)/);
                if (placeMatch) {
                    address = decodeURIComponent(placeMatch[1].replace(/\+/g, ' '));
                }
            }
            
            // Format 3: https://maps.google.com/maps?daddr=address
            if (!address) {
                const daddrMatch = mapsUrl.match(/[?&]daddr=([^&]+)/);
                if (daddrMatch) {
                    address = decodeURIComponent(daddrMatch[1]);
                }
            }
            
            // Format 4: https://maps.app.goo.gl/XXXXX (short links)
            if (!address && mapsUrl.includes('maps.app.goo.gl')) {
                // Short links need to be resolved, but we can try to extract from query params
                const shortLinkMatch = mapsUrl.match(/maps\.app\.goo\.gl\/[^/?]+/);
                if (shortLinkMatch) {
                    // For short links, we'll need to resolve them or use the full URL
                    address = mapsUrl;
                }
            }
            
            // Format 5: https://goo.gl/maps/XXXXX (old short links)
            if (!address && mapsUrl.includes('goo.gl/maps')) {
                const gooLinkMatch = mapsUrl.match(/goo\.gl\/maps\/[^/?]+/);
                if (gooLinkMatch) {
                    address = mapsUrl;
                }
            }
            
            // Format 6: Check if URL itself contains address-like text
            if (!address && mapsUrl.includes('maps')) {
                // Try to extract from the full URL
                const urlParts = mapsUrl.split('/');
                for (let part of urlParts) {
                    if (part && part !== 'maps' && part !== 'place' && part !== 'search' && part !== 'dir' && !part.startsWith('http')) {
                        const decoded = decodeURIComponent(part);
                        if (decoded.length > 5 && !decoded.match(/^[\d.]+$/)) {
                            address = decoded;
                            break;
                        }
                    }
                }
            }

            if (address) {
                geocodeAddress(address);
            } else {
                console.error('Could not extract address from URL:', mapsUrl);
                // Try to use the full URL as address
                if (mapsUrl.includes('maps')) {
                    geocodeAddress(mapsUrl);
                }
            }
        }

        // Geocode address using API
        async function geocodeAddress(address) {
            try {
                const response = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address })
                });

                const data = await response.json();
                
                if (data.success) {
                    addressData = {
                        address: data.formattedAddress,
                        addressName: data.addressName,
                        lat: data.lat,
                        lng: data.lng
                    };
                    
                    // Save to sessionStorage
                    sessionStorage.setItem('addressData', JSON.stringify(addressData));
                    
                    updateUI();
                    enableBookingButtons();
                } else {
                    console.error('Geocoding failed:', data.error);
                    alert('Could not find the address. Please try again.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error processing address. Please try again.');
            }
        }

        // Update UI with address information
        function updateUI() {
            if (addressData) {
                document.getElementById('addressName').textContent = addressData.addressName;
                document.getElementById('addressDetails').textContent = addressData.address;
                document.getElementById('addressDetails').classList.remove('no-address');
            }
        }

        // Enable booking buttons
        function enableBookingButtons() {
            if (hasAddressFromLink && addressData) {
                document.getElementById('bookUberBtn').classList.remove('disabled');
                document.getElementById('bookUberBtn').classList.add('enabled');
                document.getElementById('bookUberBtn').disabled = false;
                
                document.getElementById('bookRapidoBtn').classList.remove('disabled');
                document.getElementById('bookRapidoBtn').classList.add('enabled');
                document.getElementById('bookRapidoBtn').disabled = false;
            }
        }


        // Open Google Maps
        document.getElementById('openMapsBtn').addEventListener('click', () => {
            if (addressData) {
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addressData.address)}`;
                window.open(mapsUrl, '_blank');
            } else {
                // If no address, just open Google Maps
                window.open('https://www.google.com/maps', '_blank');
            }
        });

        // Book Uber
        document.getElementById('bookUberBtn').addEventListener('click', () => {
            if (addressData && hasAddressFromLink) {
                // Uber deep link format: uber://?action=setPickup&pickup[latitude]=LAT&pickup[longitude]=LNG
                const uberUrl = `uber://?action=setPickup&pickup[latitude]=${addressData.lat}&pickup[longitude]=${addressData.lng}`;
                
                // Try deep link first, fallback to web
                window.location.href = uberUrl;
                
                // Fallback to web after a delay
                setTimeout(() => {
                    window.open(`https://m.uber.com/ul/?action=setPickup&pickup[latitude]=${addressData.lat}&pickup[longitude]=${addressData.lng}`, '_blank');
                }, 500);
            }
        });

        // Book Rapido
        document.getElementById('bookRapidoBtn').addEventListener('click', () => {
            if (addressData && hasAddressFromLink) {
                // Rapido deep link format (may vary, this is a common pattern)
                const rapidoUrl = `rapido://ride?lat=${addressData.lat}&lng=${addressData.lng}`;
                
                // Try deep link first, fallback to web
                window.location.href = rapidoUrl;
                
                // Fallback to web after a delay
                setTimeout(() => {
                    window.open(`https://rapido.bike/?lat=${addressData.lat}&lng=${addressData.lng}`, '_blank');
                }, 500);
            }
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            // Register immediately, don't wait for load
            navigator.serviceWorker.register('/sw.js', { scope: '/' })
                .then((registration) => {
                    console.log('Service Worker registered successfully:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('New service worker found, installing...');
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New service worker installed, reload to activate');
                            }
                        });
                    });
                })
                .catch((registrationError) => {
                    console.error('Service Worker registration failed:', registrationError);
                });
            
            // Listen for controller changes
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Service worker controller changed, reloading...');
                window.location.reload();
            });
        }

        // Android PWA Install Prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = 'ðŸ“± Install App';
        installButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #4285f4; color: white; border: none; border-radius: 25px; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; display: none;';
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                installButton.style.display = 'none';
            }
        });
        document.body.appendChild(installButton);

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            installButton.style.display = 'block';
        });

        // Hide install button after installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installButton.style.display = 'none';
            deferredPrompt = null;
        });

        // Check if app is already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            installButton.style.display = 'none';
        }

        // Handle app opening from external link (for mobile)
        // This handles the case when app is opened via intent/link
        function handleIntent() {
            // Check if we're being opened from a Google Maps link
            // On mobile, this might come through different mechanisms
            
            // Check document.referrer
            if (document.referrer) {
                const referrer = document.referrer;
                if (referrer.includes('maps.google.com') || referrer.includes('google.com/maps')) {
                    hasAddressFromLink = true;
                    extractAddressFromMapsUrl(referrer);
                    return;
                }
            }
            
            // Check if URL fragment contains Google Maps link
            if (window.location.hash) {
                const hash = decodeURIComponent(window.location.hash.substring(1));
                if (hash.includes('maps.google.com') || hash.includes('google.com/maps')) {
                    hasAddressFromLink = true;
                    extractAddressFromMapsUrl(hash);
                    return;
                }
            }
            
            // Handle Web Share Target API (when shared from other apps)
            if (navigator.share && window.location.search.includes('text=')) {
                const urlParams = new URLSearchParams(window.location.search);
                const sharedText = urlParams.get('text');
                if (sharedText && (sharedText.includes('maps.google.com') || sharedText.includes('google.com/maps'))) {
                    hasAddressFromLink = true;
                    extractAddressFromMapsUrl(sharedText);
                    return;
                }
            }
        }

        // Get user info
        async function getUserInfo() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userEmail').textContent = user.email || 'User';
                    document.getElementById('userAvatar').textContent = (user.email || 'U')[0].toUpperCase();
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        // Detect iOS and show paste button
        function detectIOS() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            if (isIOS && !addressData) {
                const pasteBtn = document.getElementById('pasteLinkBtn');
                if (pasteBtn) {
                    pasteBtn.style.display = 'block';
                }
            }
        }

        // Paste link functionality for iOS
        document.getElementById('pasteLinkBtn').addEventListener('click', async () => {
            try {
                // Try to read from clipboard
                const text = await navigator.clipboard.readText();
                if (text && (text.includes('maps.google.com') || text.includes('google.com/maps'))) {
                    hasAddressFromLink = true;
                    extractAddressFromMapsUrl(text);
                    // Hide paste button after successful paste
                    document.getElementById('pasteLinkBtn').style.display = 'none';
                } else {
                    alert('Please copy a Google Maps link first, then tap this button.');
                }
            } catch (err) {
                // Fallback: show prompt for manual entry
                const mapsUrl = prompt('Paste the Google Maps link here:');
                if (mapsUrl && (mapsUrl.includes('maps.google.com') || mapsUrl.includes('google.com/maps'))) {
                    hasAddressFromLink = true;
                    extractAddressFromMapsUrl(mapsUrl);
                    document.getElementById('pasteLinkBtn').style.display = 'none';
                } else if (mapsUrl) {
                    alert('Please enter a valid Google Maps link.');
                }
            }
        });

        // Initialize
        detectIOS();
        handleIntent();
        checkForMapsLink();
        getUserInfo();
    </script>
</body>
</html>

